<!DOCTYPE html>
<html lang="en">
  <head>
    <title>360 Video Portal</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
      #enter-ar {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        font-size: 18px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="enter-ar">Enter AR</button>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
      let scene, camera, renderer, portal, doorFrame, xrSession, xrRefSpace;
      let enteredPortal = false;

      async function initAR() {
        if (!navigator.xr) {
          alert("WebXR not supported on this device.");
          return;
        }

        try {
          xrSession = await navigator.xr.requestSession("immersive-ar", {
            requiredFeatures: ["local-floor"],
          });

          const gl = document.createElement("canvas").getContext("webgl", { xrCompatible: true });
          renderer = new THREE.WebGLRenderer({ canvas: gl.canvas, context: gl, alpha: true });
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.xr.enabled = true;
          document.body.appendChild(renderer.domElement);

          scene = new THREE.Scene();
          camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
          scene.add(camera);

          xrSession.requestReferenceSpace("local-floor").then((refSpace) => {
            xrRefSpace = refSpace;
            renderer.xr.setReferenceSpaceType("local-floor");
            renderer.setAnimationLoop(() => {
              renderer.render(scene, camera);
              checkIfUserEnteredPortal();
            });
          });

          addDoorFrame();
          addPortal();
        } catch (err) {
          console.error("Failed to start AR session:", err);
        }
      }

      function addPortal() {
        let video = document.createElement("video");
        video.src = "assets/video.mp4";
        video.setAttribute("playsinline", "");
        video.setAttribute("webkit-playsinline", "");
        video.muted = false; // Enable sound for a real experience
        video.loop = true;
        video.play();

        let videoTexture = new THREE.VideoTexture(video);
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;

        let sphereGeometry = new THREE.SphereGeometry(5, 32, 32); // Large sphere
        sphereGeometry.scale(-1, 1, 1); // Flip inside out
        let sphereMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });
        
        portal = new THREE.Mesh(sphereGeometry, sphereMaterial);
        portal.position.set(0, 1.5, -6); // Place portal behind the door initially
        portal.visible = false; // Hide initially

        scene.add(portal);
      }

      function addDoorFrame() {
        const doorColor = 0x8B4513; // Brown color
        const material = new THREE.MeshBasicMaterial({ color: doorColor });

        let leftSide = new THREE.Mesh(new THREE.BoxGeometry(0.2, 3, 0.2), material);
        let rightSide = new THREE.Mesh(new THREE.BoxGeometry(0.2, 3, 0.2), material);
        let topSide = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.2, 0.2), material);

        leftSide.position.set(-1.1, 1.5, -3);
        rightSide.position.set(1.1, 1.5, -3);
        topSide.position.set(0, 3, -3);

        doorFrame = new THREE.Group();
        doorFrame.add(leftSide, rightSide, topSide);
        scene.add(doorFrame);
      }

      function checkIfUserEnteredPortal() {
        if (!enteredPortal) {
          let distance = camera.position.distanceTo(doorFrame.position);
          if (distance < 1.5) { // If user walks through the door
            enteredPortal = true;
            enterPortal();
          }
        }
      }

      function enterPortal() {
        doorFrame.visible = false; // Hide the door once entered
        portal.visible = true; // Show the 360 sphere
        portal.position.set(camera.position.x, camera.position.y, camera.position.z); // Center on user
      }

      document.getElementById("enter-ar").addEventListener("click", initAR);
    </script>
  </body>
</html>
