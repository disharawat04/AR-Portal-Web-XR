<!DOCTYPE html>
<html lang="en">
  <head>
    <title>360 Video Portal</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
      #enter-ar {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        font-size: 18px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="enter-ar">Enter AR</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
      let scene, camera, renderer, portal, xrSession, xrRefSpace;

      async function initAR() {
        if (!navigator.xr) {
          alert("WebXR not supported on this device.");
          return;
        }

        try {
          xrSession = await navigator.xr.requestSession("immersive-ar", {
            requiredFeatures: ["local"],
          });

          const gl = document.createElement("canvas").getContext("webgl", { xrCompatible: true });

          renderer = new THREE.WebGLRenderer({ canvas: gl.canvas, context: gl, alpha: true });
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.xr.enabled = true;
          document.body.appendChild(renderer.domElement);

          scene = new THREE.Scene();
          camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
          scene.add(camera);

          xrSession.requestReferenceSpace("local").then((refSpace) => {
            xrRefSpace = refSpace;
            renderer.xr.setReferenceSpaceType("local");
            renderer.setAnimationLoop(() => {
              renderer.render(scene, camera);
            });
          });

          addPortal();
          addDoorFrame();
        } catch (err) {
          console.error("Failed to start AR session:", err);
        }
      }

      function addPortal() {
        let video = document.createElement("video");
        video.src = "assets/video.mp4";
        video.setAttribute("playsinline", "");
        video.setAttribute("webkit-playsinline", "");
        video.muted = true;
        video.loop = true;
        video.play();

        let videoTexture = new THREE.VideoTexture(video);
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;

        let sphereGeometry = new THREE.SphereGeometry(10, 32, 32);
        sphereGeometry.scale(-1, 1, 1);
        let sphereMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });
        portal = new THREE.Mesh(sphereGeometry, sphereMaterial);
        portal.position.set(0, 1.5, -3);
        scene.add(portal);
      }

      function addDoorFrame() {
        let material = new THREE.MeshPhongMaterial({ color: 0x8B4513 }); // Brown color

        let verticalGeometry = new THREE.BoxGeometry(0.3, 2.5, 0.1);
        let horizontalGeometry = new THREE.BoxGeometry(2, 0.3, 0.1);

        let leftBeam = new THREE.Mesh(verticalGeometry, material);
        let rightBeam = new THREE.Mesh(verticalGeometry, material);
        let topBeam = new THREE.Mesh(horizontalGeometry, material);

        leftBeam.position.set(-1, 1.5, -3);
        rightBeam.position.set(1, 1.5, -3);
        topBeam.position.set(0, 2.75, -3);

        scene.add(leftBeam);
        scene.add(rightBeam);
        scene.add(topBeam);
      }

      document.getElementById("enter-ar").addEventListener("click", initAR);
    </script>
  </body>
</html>
